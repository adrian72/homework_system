{# app/templates/student/submit_homework.html #}
{% extends "base.html" %}

{% block title %}提交作业 - {{ homework.title }} - 作业批改系统{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('student_views.dashboard') }}">仪表盘</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('student_views.courses') }}">课程</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('student_views.course_detail', course_id=course.id) }}">{{ course.name }}</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('student_views.homework_detail', homework_id=homework.id) }}">{{ homework.title }}</a></li>
                <li class="breadcrumb-item active" aria-current="page">提交作业</li>
            </ol>
        </nav>
        
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white">
                <h5 class="mb-0">
                    <i class="fas fa-clipboard me-2"></i> {{ homework.title }}
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <p>{{ homework.description }}</p>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-light mb-3">
                            <div class="card-body">
                                <h6 class="mb-2"><i class="fas fa-info-circle me-2"></i> 作业信息</h6>
                                <p class="mb-1 small"><strong>课程：</strong> {{ course.name }}</p>
                                <p class="mb-1 small"><strong>教师：</strong> {{ course.teacher.username }}</p>
                                <p class="mb-1 small"><strong>类型：</strong> 
                                    {% if homework.assignment_type == 'essay' %}
                                        文章/图片
                                    {% elif homework.assignment_type == 'oral' %}
                                        口语/音频
                                    {% endif %}
                                </p>
                                <p class="mb-1 small">
                                    <strong>截止日期：</strong> 
                                    {% if homework.due_date %}
                                        {% if homework.due_date < now %}
                                            <span class="text-danger">{{ homework.due_date.strftime('%Y-%m-%d %H:%M') }} (已过期)</span>
                                        {% else %}
                                            {{ homework.due_date.strftime('%Y-%m-%d %H:%M') }}
                                        {% endif %}
                                    {% else %}
                                        无截止日期
                                    {% endif %}
                                </p>
                                {% if prev_submission %}
                                    <p class="mb-1 small">
                                        <strong>提交次数：</strong> {{ prev_submission.version }}
                                    </p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <h5 class="mb-0">
                    <i class="fas fa-upload me-2"></i> 提交作业
                </h5>
            </div>
            <div class="card-body">
                <form action="{{ url_for('student_views.submit_homework', homework_id=homework.id) }}" method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
                    {% if homework.assignment_type == 'essay' %}
                        <div class="mb-3">
                            <label for="text_content" class="form-label">文章内容</label>
                            <textarea class="form-control" id="text_content" name="text_content" rows="6" placeholder="请输入您的文章内容...">{{ prev_submission.content_data.text if prev_submission and prev_submission.content_data.text }}</textarea>
                            <div class="form-text">可以输入文字内容，也可以上传图片。</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="essay_images" class="form-label">上传图片</label>
                            <input type="file" class="form-control file-upload-input" id="essay_images" name="essay_images" multiple accept="image/*" data-preview="image-preview">
                            <div class="form-text">可以上传多张图片（.jpg, .jpeg, .png, .gif）。</div>
                        </div>
                        
                        <div id="image-preview" class="mb-3 d-flex flex-wrap">
                            {% if prev_submission and prev_submission.content_data.images %}
                                {% for image in prev_submission.content_data.images %}
                                    <img src="{{ image.url }}" alt="Previous image" class="image-preview mb-2 me-2" style="max-height: 150px;">
                                {% endfor %}
                                <div class="w-100 mb-2">
                                    <small class="text-muted">以上是您之前上传的图片，重新上传将会添加新图片。</small>
                                </div>
                            {% endif %}
                        </div>
                    {% elif homework.assignment_type == 'oral' %}
                        <div class="mb-3">
                            <label for="oral_audio" class="form-label">上传音频</label>
                            <input type="file" class="form-control file-upload-input" id="oral_audio" name="oral_audio" accept="audio/*" data-preview="audio-preview">
                            <div class="form-text">请上传音频文件（.mp3, .wav, .ogg）。</div>
                        </div>
                        
                        <div id="audio-preview" class="mb-3">
                            {% if prev_submission and prev_submission.content_data.audio %}
                                <audio controls class="audio-player mb-2 w-100">
                                    <source src="{{ prev_submission.content_data.audio.url }}" type="{{ prev_submission.content_data.audio.mime_type }}">
                                    您的浏览器不支持音频播放。
                                </audio>
                                <div class="mb-2">
                                    <small class="text-muted">以上是您之前上传的音频，重新上传将会替换该音频。</small>
                                </div>
                            {% endif %}
                        </div>
                    {% endif %}
                    
                    <div class="mb-3">
                        <label for="comment" class="form-label">附加说明</label>
                        <textarea class="form-control" id="comment" name="comment" rows="3" placeholder="可以添加对该提交的说明或备注...">{{ prev_submission.comment if prev_submission }}</textarea>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('student_views.homework_detail', homework_id=homework.id) }}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-1"></i> 返回
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-paper-plane me-1"></i> 提交作业
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 表单验证
        const form = document.querySelector('form.needs-validation');
        if (form) {
            form.addEventListener('submit', function(event) {
                let isValid = true;
                
                {% if homework.assignment_type == 'essay' %}
                    const textContent = document.getElementById('text_content').value;
                    const essayImages = document.getElementById('essay_images').files;
                    
                    // 检查文章内容或图片至少有一项
                    if (!textContent.trim() && essayImages.length === 0 && !document.querySelector('#image-preview img')) {
                        alert('请输入文章内容或上传图片。');
                        isValid = false;
                    }
                {% elif homework.assignment_type == 'oral' %}
                    const oralAudio = document.getElementById('oral_audio').files;
                    
                    // 检查是否上传了音频文件
                    if (oralAudio.length === 0 && !document.querySelector('#audio-preview audio')) {
                        alert('请上传音频文件。');
                        isValid = false;
                    }
                {% endif %}
                
                if (!isValid) {
                    event.preventDefault();
                    event.stopPropagation();
                }
            }, false);
        }
    });
</script>
{% endblock %}
